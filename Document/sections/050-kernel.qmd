## Kernel estimator {#sec-kernel}


I compare the results for the three different variance estimators, the HR, SCPC, and Kernel. For the Kernel estimator, I try different cut-off distances. In addition, B-Splines of different order and quantities are introduced to help improve the rejection frequency of the Kernel estimator.

In the DGP, $e_l\sim\mathcal{G}_{exp}(c_{\bar\rho})$ and $X\sim[1 \;\mathcal{G}_{exp}(c_{\bar\rho}) \;\mathcal{G}_{exp}(c_{\bar\rho})]$. The average pairwise correlation is $\bar\rho=0.03$. 

In the estimation process, Model 2 uses a demeaned outcome variable, whereas Model 1 does not. I'm using one and two-order splines (step functions and triangles). In addition, I'm using a Cholesky decomposition to invert the covariates matrix in the OLS estimator.

For every draw and every ols regression, I estimated an AR(1) model using the residuals $\hat{e}_{l+1}=\gamma_0+\gamma_1 \hat{e}_l + u_l$, after sorting from closest to zero to closest to one. 

I used 100 iterations and 2500 observations to calculate the rejection frequencies and the average AR(1) coefficients of the residuals.

@tbl-kernel displays the rejection frequencies for the different estimators. @tbl-ar1-mean displays the average AR(1) coefficients of the residuals.



```{r}
#| label: tbl-kernel
#| tbl-cap: Rejection frequencies for different variance estimators. 2,500 observations. 100 iterations.
#| echo: false
#| warning: false

kernel_results <- read.csv("../Simulations/Products/crank_bs_ear1_sims_res_2500.csv")

# row_names <- c(
#     " ",
#     "HR",
#     "SCPC",
#     "0.01",
#     "0.03",
#     "0.05",
#     "0.07",
#     "0.01",
#     "0.03",
#     "0.05",
#     "0.07"
# )

row_names <- c(
    # " ",
    "HR",
    "SCPC",
    rep(
        c(
            "0.015",
            "0.030",
            "0.050"
            # "0.07"
        ),
        9
    )
)

col_names <- c(
    "Estimator",
    rep(
        c(
            "Cons.",
            "$\\beta_1$"#,
            # "$\\beta_2$"
        ),
        2
    )
)

table <- cbind(row_names, kernel_results)

kbl(
    table, 
    digits=3, 
    booktabs = TRUE,
    col.names = col_names,
    # row.names = row_names,
    escape = F
    ) %>%
    add_header_above(
        c(" ","Model 1"=2,"Model 2"=2)
    ) %>%
    pack_rows(
        "Kernel",3,5
    ) %>%
    pack_rows(
        "B-Splines order 1 (Step functions)",6,17, latex_align = "l", hline_after = TRUE
    ) %>%
    pack_rows(
        "B-Splines order 2 (Triangles)",18,29, latex_align = "l", hline_after = TRUE
    ) %>%
    pack_rows(
        "Kernel + B-S, 4 splines",6,8
    ) %>%
    pack_rows(
        "Kernel + B-S, 12 splines",9,11
    ) %>%
    pack_rows(
        "Kernel + B-S, 24 splines",12,14
    ) %>%
    pack_rows(
        "Kernel + B-S, 36 splines",15,17
    ) %>%
    pack_rows(
        "Kernel + B-S, 4 splines",18,20
    ) %>%
    pack_rows(
        "Kernel + B-S, 12 splines",21,23
    ) %>%
    pack_rows(
        "Kernel + B-S, 24 splines",24,26
    ) %>%
    pack_rows(
        "Kernel + B-S, 36 splines",27,29
    ) #%>%
 



```

```{r}
#| label: tbl-ar1-mean
#| tbl-cap: Average coefficients of the AR(1) model for the residuals. Spatial data. 2500 obs. 100 iterations.
#| echo: false
#| warning: false


e_ar1_tbl <- read.csv("../Simulations/Products/crank_bs_ear1_sims_ar1_2500.csv")



row_names_ar1 <- c(
    "No splines",
    rep(
        c(
        "4 splines",
        "12 splines",
        "24 splines",
        "36 splines"
        ),
        2
    )
)

col_names_ar1 <- c(
    "",
    rep(
        c(
            "Cons.",
            "$\\gamma_1$"#,
            # "$\\beta_2$"
        ),
        2
    )
)

table_ar1 <- cbind(row_names_ar1, e_ar1_tbl)

kbl(
    table_ar1, 
    digits=3, 
    booktabs = TRUE,
    col.names = col_names_ar1,
    # row.names = row_names,
    escape = F
    ) %>%
    add_header_above(
        c(" ","$e_l$ model 1"=2,
        "$e_l$ model 2"=2),
        escape = FALSE
    ) %>%
    pack_rows(
        "B-Splines order 1 (Step functions)",2,5, latex_align = "l", hline_after = TRUE
    ) %>%
    pack_rows(
        "B-Splines order 2 (Triangles)",6,9, latex_align = "l", hline_after = TRUE
    )
 



```


<!-- 
::: {#fig-bspline layout-ncol=2 include=false}

![4 Splines]("../Simulations/Products/bs_plot_4.png")

![5 Splines]("../Simulations/Products/bs_plot_5.png")

![6 Splines]("../Simulations/Products/bs_plot_6.png")

![7 Splines]("../Simulations/Products/bs_plot_7.png")

Second order B-Splines
::: -->


```{r}
#| echo: false
#| fig-align: center
#| fig-cap: Second order B-Splines
#| width: 1300px
#| include: false

knitr::include_graphics("../Simulations/Products/bspline_order_2.png")

```

