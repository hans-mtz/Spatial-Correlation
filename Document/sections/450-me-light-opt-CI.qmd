## Ideal Confidence Intervals

The first column of estimates in @tbl-lights-me-optimal-ci shows the difference between the percentile 97.5 and 2.5 of the empirical distribution of $t$ statistic from the simulated data. In other words, for each simulated DGP, I estimated a $t$ statistic for each variance estimator. After 1000 simulations, I obtained a distribution of $t$ statistics for each estimator. The first column of estimates shows the centered distance for the 95% region of the distribution. 

The second column of @tbl-lights-me-optimal-ci shows two times the value of the percentile 95 percentile of the empirical distribution of the absolute value of the $t$ statistic of the simulated data for each variance estimator. The objective was to make the approach of column one symmetric. 

The third column shows the sample standard deviation of the distribution of the t statistic times two times the 1.96 theoretical critical value of the 95% significance level. 

Finally, the fourth column is similar to column three but for the absolute value of the $t$ statistic for each variance estimator. In other words, the sample standard deviation of the absolute value of the $t$-statistic values times two times 1.96, the critical value of the 5% significance level.

@tbl-lights-me-optimal-ci-98 replicates the same exercise but for the 2% significance level. The first column is the difference between the 99 and 1 percentile of the empirical $t$-statistic distribution. The second column is the 98 percentile of the distribution of the absolute value of the $t$-statistic values. The third column displays the sample standard deviation times two times 2.236, the critical value of the 98 percentile of the theoretical $t$ student distribution. The fourth column is the sample standard deviation of the absolute values of the $t$-statistics from simulations times two times 2.236.

The tables display the average Damian's distance. Damian's distance changes according to the number of splines. Since the number of splines is chosen to reduce the NN correlation for every DGP, the number of splines changes in every simulation. 

{{< pagebreak >}}

```{r}
#| label: tbl-lights-me-optimal-ci
#| tbl-cap: 95 percent CI lengths for different variance estimators. Spatial data with highly concentrated two-dimensional mismeasured locations. Selecting the number of B Splines using the lowest Nearest Neighbour (NN) correlation in residuals from a grid going from 4 to 12 splines. ME radius is 3 percent. DGP's $\bar\rho$ is 0.03. C-SCPC/SCPC $\bar\rho_{max}$ is 0.03.
#| eval: true
#| include: true

## Setting variables

excercise <- "light_locs_me_3p_optimal_CI"

## Reading data generated by Matlab ####
e_ar1_tbl <- read.csv(
    paste0(products_folder, "opt_spline_sims_ar1_", excercise, ".csv")
)

optimal_CI_table <- read.csv(
    paste0(products_folder, "opt_ci_table_", excercise, ".csv")
)
splines_table <- read.csv(
    paste0(products_folder, "splines_damians_d_", excercise, ".csv")
)

## Arranging the data ####
damians_d <-splines_table %>%
    summarise(
        across(
            starts_with("DD"),
            mean
        )
    )


notes <- c(
    rep("",12), 
    round(damians_d[[1]], digits = 3),
    round(damians_d[[2]], digits = 3)
)

row_names_kernel<- c(
    "HR",
    "SCPC",
    "C-SCPC",
    "Kernel 0.015",
    "Kernel 0.030",
    "Kernel 0.050",
    "Kernel 0.070",
    "HR",
    "Kernel 0.015",
    "Kernel 0.030",
    "Kernel 0.050",
    "Kernel 0.070",
    "D's x2 ",
    "D's x3 "
)

row_names_kernel_notes <-paste0(row_names_kernel,notes)

aux <- c(
    rep(
        "",
        4+3
    ),
    rep(
        c(
            "Order 1"#,
            # "Order 2"
        ),
        each = 6+1
    )
)

table_ci <- cbind(
    aux,
    row_names_kernel_notes, 
    optimal_CI_table
)

names(table_ci)<- c(
    "Splines",
    "Estimator",
    "$t_{97.5p-2.5p}$",
    "$t_{97.5p-2.5p} $",
    "$|t|_{95p}$",
    "$|t|_{95p} $",
    "$t_{S.D.}\\times 1.96$",
    "$t_{S.D.}\\times 1.96 $",
    "$|t|_{S.D.}\\times 1.96$",
    "$|t|_{S.D.}\\times 1.96 $"
)

aux2 <- c(
    rep(
        "",
        1
    ),
    rep(
        c(
            "Order 1"#,
            # "Order 2"
        ),
        1
    )
)

table_ar1 <-cbind(
    aux2,
    e_ar1_tbl
)

names(table_ar1)<-c(
    "Splines",
    "NN",
    "Tim's Stat",
    "BIC",
    "Damian's",
    "Dropped"
)

table<-merge(table_ci,table_ar1[,c(1,3)], by="Splines",sort=FALSE)

kbl(
    table[,c(1,2,4,6,8,10)], #- id, 
    digits=3,#c(3,3,5,3), 
    booktabs = TRUE,
    longtable = TRUE,
    # col.names = col_names,
    # row.names = row_names,
    escape = FALSE,
    position = "p"#,
    # format.args = list(scientific=TRUE)
    ) %>%
    add_header_above(
        c(" "=2,"\\\\(\\\\beta_1\\\\)"=4),
        escape = FALSE
    ) %>%
    # add_header_above(
    #     c(" "=1,"Spatial data"=6,"Residuals"=3)
    # ) %>%
    collapse_rows(
        1,
        latex_hline = "custom",
        custom_latex_hline = 1,
        valign = "top"#,
        # row_group_label_position = "stack"
    ) #%>%

```


{{< pagebreak >}}

```{r}
#| label: tbl-lights-me-optimal-ci-98
#| tbl-cap: 98 percent CI lengths for different variance estimators. Spatial data with highly concentrated two-dimensional mismeasured locations. Selecting the number of B Splines using the lowest Nearest Neighbour (NN) correlation in residuals from a grid going from 4 to 12 splines. ME radius is 3 percent. DGP's $\bar\rho$ is 0.03. C-SCPC/SCPC $\bar\rho_{max}$ is 0.03.
#| eval: true
#| include: true

## Setting variables

# excercise <- "light_locs_me_3p_optimal_CI"

## Reading data generated by Matlab ####
# e_ar1_tbl <- read.csv(
#     paste0(products_folder, "opt_spline_sims_ar1_", excercise, ".csv")
# )

optimal_CI_table_98 <- read.csv(
    paste0(products_folder, "opt_98_ci_table_", excercise, ".csv")
)
# splines_table <- read.csv(
#     paste0(products_folder, "splines_damians_d_", excercise, ".csv")
# )

## Arranging the data ####
# damians_d <-splines_table %>%
#     summarise(
#         across(
#             starts_with("DD"),
#             mean
#         )
#     )


# notes <- c(
#     rep("",12), 
#     round(damians_d[[1]], digits = 3),
#     round(damians_d[[2]], digits = 3)
# )

# row_names_kernel<- c(
#     "HR",
#     "SCPC",
#     "C-SCPC",
#     "Kernel 0.015",
#     "Kernel 0.030",
#     "Kernel 0.050",
#     "Kernel 0.070",
#     "HR",
#     "Kernel 0.015",
#     "Kernel 0.030",
#     "Kernel 0.050",
#     "Kernel 0.070",
#     "D's x2 ",
#     "D's x3 "
# )

# row_names_kernel_notes <-paste0(row_names_kernel,notes)

# aux <- c(
#     rep(
#         "",
#         4+3
#     ),
#     rep(
#         c(
#             "Order 1"#,
#             # "Order 2"
#         ),
#         each = 6+1
#     )
# )

table_ci_98 <- cbind(
    aux,
    row_names_kernel_notes, 
    optimal_CI_table_98
)

names(table_ci_98)<- c(
    "Splines",
    "Estimator",
    "$t_{99p-1p}$",
    "$t_{99p-1p} $",
    "$|t|_{98p}$",
    "$|t|_{98p} $",
    "$t_{S.D.}\\times 2.236$",
    "$t_{S.D.}\\times 2.236 $",
    "$|t|_{S.D.}\\times 2.236$",
    "$|t|_{S.D.}\\times 2.236 $"
)

# aux2 <- c(
#     rep(
#         "",
#         1
#     ),
#     rep(
#         c(
#             "Order 1"#,
#             # "Order 2"
#         ),
#         1
#     )
# )

# table_ar1 <-cbind(
#     aux2,
#     e_ar1_tbl
# )

# names(table_ar1)<-c(
#     "Splines",
#     "NN",
#     "Tim's Stat",
#     "BIC",
#     "Damian's",
#     "Dropped"
# )

table_98<-merge(table_ci_98,table_ar1[,c(1,3)], by="Splines",sort=FALSE)

kbl(
    table_98[,c(1,2,4,6,8,10)], #- id, 
    digits=3,#c(3,3,5,3), 
    booktabs = TRUE,
    longtable = TRUE,
    # col.names = col_names,
    # row.names = row_names,
    escape = FALSE,
    position = "p"#,
    # format.args = list(scientific=TRUE)
    ) %>%
    add_header_above(
        c(" "=2,"\\\\(\\\\beta_1\\\\)"=4), 
        escape = FALSE
    ) %>%
    # add_header_above(
    #     c(" "=1,"Spatial data"=6,"Residuals"=3)
    # ) %>%
    collapse_rows(
        1,
        latex_hline = "custom",
        custom_latex_hline = 1,
        valign = "top"#,
        # row_group_label_position = "stack"
    ) #%>%

```


{{< pagebreak >}}


```{r}
#| label: tbl-hc-locs-me
#| tbl-cap: Rejection frequencies for different variance estimators. Spatial data with highly concentrated two-dimensional mismeasured locations. Selecting the number of B Splines using the lowest Nearest Neighbour (NN) correlation in residuals from a grid going from 4 to 12 splines. ME radius is 3 percent. DGP's $\bar\rho$ is 0.03. C-SCPC/SCPC $\bar\rho_{max}$ is 0.03.
#| echo: false
#| warning: false
#| eval: true
#| include: true

# kernel_results <- read.csv("../Simulations/Products/opt_spline_sims_res_light_locs_me_3p_matching.csv")

# e_ar1_tbl <- read.csv("../Simulations/Products/opt_spline_sims_ar1_light_locs_me_3p_matching.csv")

# excercise <- "light_locs_me_3p_matching"
excercise <- 'light_locs_me_3p_optimal_CI'

kernel_results <- read.csv(
    paste0(products_folder,"opt_spline_sims_res_", excercise,".csv")
)

e_ar1_tbl <- read.csv(
    paste0(products_folder,"opt_spline_sims_ar1_", excercise, ".csv")
)

# optimal_CI_table <- read.csv(
#     paste0(products_folder, "opt_ci_table_", excercise, ".csv")
# )

# notes <- c(rep("",5),"$^a$",rep("",9),"$^b$")
# row_names_kernel<- c(
#     "HR",
#     "SCPC",
#     "C-SCPC",
#     rep(
#         c(
#             "Kernel 0.015",
#             "Kernel 0.030",
#             "Kernel 0.050"#,
#             # "Damian's"
#         ),
#         1
#     ),
#         rep(
#         c(
#             "HR",
#             "Kernel 0.015",
#             "Kernel 0.030",
#             "Kernel 0.050",
#             "Damian's (x2)",
#             "Damian's (x3)"

#         ),
#         1
#     )
# )
# row_names_kernel_notes <-paste0(row_names_kernel,notes)
aux <- c(
    rep(
        "",
        4+3
    ),
    rep(
        c(
            "Order 1"#,
            # "Order 2"
        ),
        each = 6+1
    )
)

table_kernel <- cbind(
    aux,
    row_names_kernel_notes, 
    kernel_results#, 
)
names(table_kernel)<- c(
    "Splines",
    "Estimator",
    "Cons.",
    "$\\beta_1$",
    "Cons. ",
    "$\\beta_1$ ",
    "$i$"
)

# aux2 <- c(
#     rep(
#         "",
#         1
#     ),
#     rep(
#         c(
#             "Order 1"#,
#             # "Order 2"
#         ),
#         1
#     )
# )

# table_ar1 <-cbind(
#     aux2,
#     e_ar1_tbl
# )
# names(table_ar1)<-c(
#     "Splines",
#     "NN",
#     "Slope",
#     "BIC",
#     "Damian's",
#     "Dropped"
# )
table<-merge(table_kernel,table_ar1, by="Splines",sort=FALSE)

kbl(
    # table[,-c(9,11)], #- id,
    table[,c(1,2,4,6,7,8,10,12)],
    digits=3,#c(3,3,5,3), 
    booktabs = TRUE,
    longtable = TRUE,
    # col.names = col_names,
    # row.names = row_names,
    escape = F,
    position = "p"#,
    # format.args = list(scientific=TRUE)
    ) %>%
    add_header_above(
        c(" "=3,"C.I. length"=1)
    ) %>%
    add_header_above(
        c(" "=1,"Spatial data"=4,"Residuals"=3)
    ) %>%
    collapse_rows(
        c(1,6:8),
        latex_hline = "custom",
        custom_latex_hline = 1,
        valign = "top"#,
        # row_group_label_position = "stack"
    ) #%>%

```

The average number of splines is `r round(mean(splines_table$Qty..O1)[[1]],digits=2)`. 